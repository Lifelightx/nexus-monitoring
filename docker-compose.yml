
services:
  # ============================================
  # TELEMETRY INFRASTRUCTURE
  # ============================================
  
  # ClickHouse - Traces & Logs Database
  clickhouse:
    image: clickhouse/clickhouse-server:24.1-alpine
    container_name: clickhouse
    ports:
      - "30123:8123"  # HTTP
      - "30900:9000"  # Native
    environment:
      CLICKHOUSE_DB: otel
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./BACKEND/config/clickhouse-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./BACKEND/config/clickhouse_listen.xml:/etc/clickhouse-server/config.d/listen.xml:ro
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # VictoriaMetrics - Metrics Time-Series Database
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.97.1
    container_name: victoriametrics
    ports:
      - "30428:8428"  # HTTP API
    command:
      - "--storageDataPath=/storage"
      - "--httpListenAddr=:8428"
      - "--retentionPeriod=12"  # 12 months retention
    volumes:
      - victoria_data:/storage
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8428/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # APPLICATION SERVICES
  # ============================================

  # MongoDB - Legacy data store (for existing services)
  mongo:
    image: mongo:latest
    container_name: mongo
    ports:
      - "27018:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - nexus-network

  # Backend - Node.js API with OTLP Ingest
  # backend:
  #   build:
  #     context: ./BACKEND
  #     dockerfile: Dockerfile
  #   container_name: nexus-backend
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - PORT=3000
  #     - SERVER_HOST=0.0.0.0
  #     - JWT_SECRET=nxUeS@ge6^7%394JnOmJeebanHRt
  #     - MONGO_URI=mongodb://mongo:27017/nexus-monitor
  #     - KAFKA_BROKERS=redpanda:9092
  #     - AGENT_TOKEN_EXPIRY=30d
  #     - KAFKA_TOPIC_TRACES=traces
  #     - KAFKA_TOPIC_METRICS=otel_metrics
  #     - KAFKA_TOPIC_LOGS=otel_logs
  #   depends_on:
  #     - mongo
  #     - redpanda
  #     - otel-collector
  #   networks:
  #     - nexus-network
  #   restart: unless-stopped

networks:
  nexus-network:
    driver: bridge

volumes:
  
  clickhouse_data:
  victoria_data:
  mongo_data:
